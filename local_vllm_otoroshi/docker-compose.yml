version: '3.8'

services:
  # Service Ollama (Inférence)
  # Image officielle Ollama (support ROCm inclus ou via tag spécifique si besoin)
  ollama:
    image: ollama/ollama:rocm
    container_name: ollama
    restart: unless-stopped
    volumes:
      - ollama_data:/root/.ollama
    # Mapping des périphériques pour l'accès GPU AMD
    devices:
      - /dev/kfd:/dev/kfd
      - /dev/dri:/dev/dri
    # Variables d'environnement pour forcer l'utilisation du GPU
    environment:
      - HSA_OVERRIDE_GFX_VERSION=11.0.2  # RDNA3.5 pour Radeon 860M
      - OLLAMA_DEBUG=1  # Active les logs de debug
      - GPU_DEVICE_ORDINAL=0
      - HIP_VISIBLE_DEVICES=0
      - ROCR_VISIBLE_DEVICES=0
      # Décommentez pour forcer CPU si GPU ne fonctionne pas:
      # - OLLAMA_NUM_GPU=0
    ports:
      - "11434:11434"
    # Ajouter les capabilities pour un meilleur accès GPU
    security_opt:
      - seccomp:unconfined
    # Utiliser root pour éviter les problèmes de permissions
    user: "0:0"
    networks:
      - otoroshi-network

  # Service Otoroshi (API Gateway)
  otoroshi:
    image: maif/otoroshi:latest
    container_name: otoroshi
    restart: unless-stopped
    ports:
      - "8080:8080" # UI et API
      - "8443:8443" # HTTPS
    environment:
      - OTOROSHI_INITIAL_ADMIN_LOGIN=admin@otoroshi.io
      - OTOROSHI_INITIAL_ADMIN_PASSWORD=password
      - APP_DOMAIN=oto.tools
      - PLAY_HTTP_SECRET=my-secret-random-string
      - OTOROSHI_INITIAL_ADMIN_API_KEY_ID=admin-api-apikey-id
      - OTOROSHI_INITIAL_ADMIN_API_KEY_SECRET=admin-api-apikey-secret
    depends_on:
      - ollama
    networks:
      - otoroshi-network

networks:
  otoroshi-network:
    driver: bridge

volumes:
  ollama_data:
